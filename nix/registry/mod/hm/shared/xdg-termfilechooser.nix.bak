/**
  XDG terminal file chooser (yazi + kitty).
  
  Backup of termfilechooser configuration, disabled in favor of
  system-level xdg-desktop-portal-gnome from programs.niri.enable.
  
  To re-enable:
  1. Add xdg-desktop-portal-termfilechooser to home.packages
  2. Add these to home.file
  3. Add portals.conf with FileChooser=termfilechooser
*/
{ pkgs, config, ... }:
let
  cfgHome = config.xdg.configHome;

  yaziWrapper = pkgs.writeShellScript "xdg-yazi-wrapper" ''
    set -eu

    multiple="$1"
    directory="$2"
    save="$3"
    path="$4"
    out="$5"

    if [ "$save" = "1" ]; then
      set -- --chooser-file="$out" "$path"
    elif [ "$directory" = "1" ]; then
      set -- --chooser-file="$out" --cwd-file="$out"".1" "$path"
    elif [ "$multiple" = "1" ]; then
      set -- --chooser-file="$out" "$path"
    else
      set -- --chooser-file="$out" "$path"
    fi

    exec kitty --title 'XDG File Picker' ${pkgs.yazi}/bin/yazi "$@"

    if [ "$directory" = "1" ] && [ ! -s "$out" ] && [ -s "$out"".1" ]; then
      cat "$out"".1" > "$out"
      rm "$out"".1"
    fi
  '';
in
{
  home.packages = [ pkgs.xdg-desktop-portal-termfilechooser ];

  home.file = {
    "${cfgHome}/xdg-desktop-portal-termfilechooser/config".text = ''
      [filechooser]
      cmd=$XDG_CONFIG_HOME/xdg-desktop-portal-termfilechooser/yazi-wrapper.sh
      default_dir=$HOME
      env=TERMCMD=kitty --title 'XDG File Picker'
      open_mode=suggested
      save_mode=suggested
    '';

    "${cfgHome}/xdg-desktop-portal/portals.conf".text = ''
      [preferred]
      org.freedesktop.impl.portal.FileChooser=termfilechooser
    '';

    "${cfgHome}/xdg-desktop-portal-termfilechooser/yazi-wrapper.sh" = {
      source = yaziWrapper;
      executable = true;
    };
  };
}
